name: Deploy Pa11y Webservice to Ubuntu Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: pa11y-webservice
  DEPLOY_PATH: /opt/pa11y-webservice

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r . deploy-package/
          cd deploy-package
          rm -rf .git .github node_modules
          tar -czf ../deploy.tar.gz .
          cd ..
          rm -rf deploy-package

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          COSMOS_DB_CONNECTION: ${{ secrets.COSMOS_DB_CONNECTION }}
        run: |
          # Copy deployment package to server
          scp -i ~/.ssh/deploy_key deploy.tar.gz $SSH_USER@$SSH_HOST:/tmp/

          # SSH into server and deploy
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e
            
            # Create deployment directory if it doesn't exist
            sudo mkdir -p ${{ env.DEPLOY_PATH }}
            sudo chown $USER:$USER ${{ env.DEPLOY_PATH }}
            
            # Extract new code
            cd ${{ env.DEPLOY_PATH }}
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz
            
            # Create .env file with Cosmos DB connection
            cat > .env << 'EOF'
NODE_ENV=production
PORT=3000
DATABASE=${{ secrets.COSMOS_DB_CONNECTION }}
LOG_LEVEL=info
EOF
            
            # Stop existing containers
            docker-compose down || true
            
            # Build and start new containers
            docker-compose up -d --build
            
            # Clean up old images
            docker image prune -af
            
            # Show status
            docker-compose ps
          ENDSSH

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            # Wait for service to be ready
            sleep 15
            
            # Check if containers are running
            if docker-compose ps | grep -q "Up"; then
              echo "✅ Deployment successful - containers are running"
              docker-compose logs --tail=50
            else
              echo "❌ Deployment failed - containers not running"
              docker-compose logs
              exit 1
            fi
          ENDSSH

      - name: Cleanup SSH keys
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key